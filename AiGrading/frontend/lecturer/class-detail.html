<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Class Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <style>
      .breadcrumb { --bs-breadcrumb-divider: '›'; }
      .tab-content > .tab-pane { padding-top: 1rem; }
      .nav-tabs .nav-link { cursor: pointer; }
      .table td, .table th { vertical-align: middle; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="../lecturer/dashboard.html"><i class="bi bi-mortarboard me-2"></i>AI Grading</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#lecturerNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="lecturerNav">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link active" href="classes.html">Classes</a></li>
            <li class="nav-item"><a class="nav-link" href="grade-queue.html">Grade Queue</a></li>
          </ul>
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="roleMenu" role="button" data-bs-toggle="dropdown">Lecturer</a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="../student/dashboard.html">Switch to Student</a></li>
                <li><a class="dropdown-item" href="../admin/dashboard.html">Switch to Admin</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="../logout.html">Log Out</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <main class="container my-4">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="classes.html">Lecturer</a></li>
          <li class="breadcrumb-item"><a href="classes.html">Classes</a></li>
          <li id="lecturerClassCrumb" class="breadcrumb-item active" aria-current="page">Class</li>
        </ol>
      </nav>
      <h3 id="classNameHeader" class="mb-3">Class Name</h3>
      <ul class="nav nav-tabs" id="lecturerClassTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="roster-tab" data-bs-toggle="tab" data-bs-target="#tab-roster" type="button" role="tab" aria-controls="tab-roster" aria-selected="true">Roster</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="lassign-tab" data-bs-toggle="tab" data-bs-target="#tab-assignments" type="button" role="tab" aria-controls="tab-assignments" aria-selected="false">Assignments</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="submissions-tab" data-bs-toggle="tab" data-bs-target="#tab-submissions" type="button" role="tab" aria-controls="tab-submissions" aria-selected="false">Submissions</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="gradebook-tab" data-bs-toggle="tab" data-bs-target="#tab-gradebook" type="button" role="tab" aria-controls="tab-gradebook" aria-selected="false">Gradebook</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="appeals-tab" data-bs-toggle="tab" data-bs-target="#tab-appeals" type="button" role="tab" aria-controls="tab-appeals" aria-selected="false">Appeals</button>
        </li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-roster" role="tabpanel" aria-labelledby="roster-tab">
          <div class="my-3">
            <table class="table table-sm">
              <thead><tr><th>ID</th><th>Name</th><th>Action</th></tr></thead>
              <tbody id="rosterTable"></tbody>
            </table>
            <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addStudentModal">Add Student</button>
          </div>
        </div>
        <div class="tab-pane fade" id="tab-assignments" role="tabpanel" aria-labelledby="lassign-tab">
          <div class="text-end my-2">
            <a id="newAssignLink" href="#" class="btn btn-primary btn-sm">New Assignment</a>
          </div>
          <ul id="assignmentList" class="list-group"></ul>
        </div>
        <div class="tab-pane fade" id="tab-submissions" role="tabpanel" aria-labelledby="submissions-tab">
          <div class="row mb-3">
            <div class="col-md-6">
              <select id="submissionAssignmentFilter" class="form-select form-select-sm">
                <option value="">All Assignments</option>
              </select>
            </div>
            <div class="col-md-6">
              <select id="submissionStatusFilter" class="form-select form-select-sm">
                <option value="">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="graded">Graded</option>
                <option value="appealed">Appealed</option>
              </select>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped table-sm">
              <thead>
                <tr>
                  <th>Student</th>
                  <th>Assignment</th>
                  <th>File</th>
                  <th>Status</th>
                  <th>Score</th>
                  <th>Submitted</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="submissionsTable"></tbody>
            </table>
          </div>
        </div>
        <div class="tab-pane fade" id="tab-gradebook" role="tabpanel" aria-labelledby="gradebook-tab">
          <div class="table-responsive">
            <table class="table table-bordered table-sm text-center">
              <thead><tr id="gradebookHeader"><th>Student</th></tr></thead>
              <tbody id="gradebookBody"></tbody>
            </table>
          </div>
        </div>
        <div class="tab-pane fade" id="tab-appeals" role="tabpanel" aria-labelledby="appeals-tab">
          <table class="table table-sm">
            <thead><tr><th>Student</th><th>Assignment</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="appealsTable"></tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addStudentModalLabel">Add Student</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <label for="addStudentSelect" class="form-label">Select student to add:</label>
            <select id="addStudentSelect" class="form-select"></select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="confirmAddBtn" class="btn btn-primary btn-sm">Add</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Accept Appeal Modal -->
    <div class="modal fade" id="acceptModal" tabindex="-1" aria-labelledby="acceptModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <h6 class="modal-title" id="acceptModalLabel">Accept Appeal</h6>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">Are you sure you want to accept this appeal?</div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="confirmAcceptBtn" class="btn btn-success btn-sm">Accept</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Deny Appeal Modal -->
    <div class="modal fade" id="denyModal" tabindex="-1" aria-labelledby="denyModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <h6 class="modal-title" id="denyModalLabel">Deny Appeal</h6>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">Are you sure you want to deny this appeal?</div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="confirmDenyBtn" class="btn btn-danger btn-sm">Deny</button>
          </div>
        </div>
      </div>
    </div>

    <footer class="bg-light text-center py-3 mt-5"><small class="text-muted">AI Grading Demo &copy; 2025</small></footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

    <!-- Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
      <div id="liveToast" class="toast text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body" id="toastBody">Action performed.</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    </div>

    <script>
      window.__demo = {
        "lecturers":[{"id":"L001","name":"Dr. Ada Lee"},{"id":"L002","name":"Prof. Kelvin Chan"}],
        "classes":[
          {"id":"SE101","name":"Software Engineering I","lecturerId":"L001",
           "assignments":[{"id":"A1","title":"Lab 1 – Arrays","due":"2025-09-30"},{"id":"A2","title":"Essay – Software Ethics","due":"2025-10-10"}],
           "students":["S20721831","S20720001"]}],
        "students":[{"id":"S20721831","name":"Alice Chan"},{"id":"S20720001","name":"Bob Lee"},{"id":"S20719999","name":"Evan Ho"}],
        "submissions":[
          {"id":"SUB1","classId":"SE101","assignmentId":"A1","studentId":"S20721831","status":"Graded","score":88,"submitted":"2025-09-25","content":"// Code..."},
          {"id":"SUB2","classId":"SE101","assignmentId":"A1","studentId":"S20720001","status":"Appealed","score":72,"submitted":"2025-09-25","content":"// Code..."},
          {"id":"SUB3","classId":"SE101","assignmentId":"A2","studentId":"S20721831","status":"Grading","score":null,"submitted":"2025-10-01","content":"Essay..."},
          {"id":"SUB4","classId":"SE101","assignmentId":"A2","studentId":"S20720001","status":"Queued","score":null,"submitted":"2025-10-02","content":"Essay..."}
        ],
        "rubricCriteria":[{"name":"Correctness","weight":40},{"name":"Style","weight":20},{"name":"Documentation","weight":20},{"name":"Efficiency","weight":20}],
        "appeals":[{"id":"APP1","submissionId":"SUB2","studentId":"S20720001","classId":"SE101","assignmentId":"A1","status":"Under Review","submitted":"2025-09-26",
          "timeline":[{"status":"Submitted","date":"2025-09-26","note":"Student requested regrade."},{"status":"Under Review","date":"2025-09-27","note":"Instructor re-evaluating."}]}]
      };
      const params = new URLSearchParams(window.location.search);
      const classId = params.get('classId') || 'SE101';
      const classData = window.__demo.classes.find(c => c.id === classId);
      if (classData) {
        document.getElementById('lecturerClassCrumb').textContent = classData.id;
        document.getElementById('classNameHeader').innerText = `${classData.id} – ${classData.name}`;
        // Roster
        const rosterTable = document.getElementById('rosterTable');
        rosterTable.innerHTML = classData.students.map(sid => {
          const student = window.__demo.students.find(s => s.id === sid);
          return `<tr><td>${sid}</td><td>${student.name}</td><td><button class="btn btn-sm btn-outline-danger remove-student-btn" data-student="${sid}"><i class="bi bi-person-x"></i></button></td></tr>`;
        }).join('');
        // Add student select
        const addSelect = document.getElementById('addStudentSelect');
        addSelect.innerHTML = '';
        const notEnrolled = window.__demo.students.filter(st => !classData.students.includes(st.id));
        for (const st of notEnrolled) {
          const opt = document.createElement('option');
          opt.value = st.id; opt.textContent = `${st.id} – ${st.name}`;
          addSelect.appendChild(opt);
        }
        // Assignments tab
        const assignmentList = document.getElementById('assignmentList');
        assignmentList.innerHTML = classData.assignments.map(asmt => {
          const totalSubs = window.__demo.submissions.filter(sub => sub.classId === classData.id && sub.assignmentId === asmt.id).length;
          const gradedSubs = window.__demo.submissions.filter(sub => sub.classId === classData.id && sub.assignmentId === asmt.id && sub.status !== 'Queued' && sub.status !== 'Grading').length;
          const statusText = totalSubs ? `${gradedSubs}/${totalSubs} graded` : 'No submissions yet';
          return `<li class="list-group-item d-flex justify-content-between align-items-center">
            <div><strong>${asmt.id}</strong> – ${asmt.title} <small class="text-muted">(Due ${asmt.due})</small><br><small>Status: ${statusText}</small></div>
            <a href="grade-queue.html?classId=${classData.id}&assignmentId=${asmt.id}" class="btn btn-sm btn-outline-primary">Grade</a>
          </li>`;
        }).join('');
        document.getElementById('newAssignLink').href = `assignment-new.html?classId=${classData.id}`;
        // Gradebook
        const gradeHeader = document.getElementById('gradebookHeader');
        gradeHeader.innerHTML = '<th>Student</th>' + classData.assignments.map(a => `<th>${a.id}</th>`).join('');
        const gradeBody = document.getElementById('gradebookBody');
        gradeBody.innerHTML = classData.students.map(sid => {
          const student = window.__demo.students.find(s => s.id === sid);
          let row = `<tr><td class="text-start">${student.name}</td>`;
          for (const asmt of classData.assignments) {
            const sub = window.__demo.submissions.find(sub => sub.classId === classData.id && sub.assignmentId === asmt.id && sub.studentId === sid);
            if (sub) {
              if (sub.status === 'Queued' || sub.status === 'Grading') {
                row += `<td><a href="grade-detail.html?submissionId=${sub.id}">Grade</a></td>`;
              } else {
                row += `<td>${sub.score}${sub.status==='Appealed' ? '*' : ''}</td>`;
              }
            } else {
              row += '<td>&mdash;</td>';
            }
          }
          row += '</tr>';
          return row;
        }).join('');
        // Appeals
        const appealsTable = document.getElementById('appealsTable');
        const classAppeals = window.__demo.appeals.filter(a => a.classId === classData.id);
        appealsTable.innerHTML = classAppeals.map(app => {
          const student = window.__demo.students.find(s => s.id === app.studentId);
          return `<tr><td>${student.name}</td><td>${app.assignmentId}</td><td>${app.status}</td><td>
            <button class="btn btn-success btn-sm accept-btn" data-appeal="${app.id}" data-bs-toggle="modal" data-bs-target="#acceptModal">Accept</button>
            <button class="btn btn-danger btn-sm deny-btn" data-appeal="${app.id}" data-bs-toggle="modal" data-bs-target="#denyModal">Deny</button>
          </td></tr>`;
        }).join('');
      }
      // Remove student
      document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-student-btn')) {
          const btn = e.target.closest('.remove-student-btn');
          const sid = btn.getAttribute('data-student');
          btn.closest('tr').remove();
          classData.students = classData.students.filter(s => s !== sid);
          document.getElementById('toastBody').innerText = 'Removed student ' + sid;
          new bootstrap.Toast(document.getElementById('liveToast')).show();
        }
      });
      // Add student confirm
      document.getElementById('confirmAddBtn').addEventListener('click', () => {
        const select = document.getElementById('addStudentSelect');
        const sid = select.value;
        if (sid) {
          classData.students.push(sid);
          const student = window.__demo.students.find(s => s.id === sid);
          const newRow = document.createElement('tr');
          newRow.innerHTML = `<td>${sid}</td><td>${student.name}</td><td><button class="btn btn-sm btn-outline-danger remove-student-btn" data-student="${sid}"><i class="bi bi-person-x"></i></button></td>`;
          document.getElementById('rosterTable').appendChild(newRow);
          select.querySelector(`option[value="${sid}"]`).remove();
          const modal = bootstrap.Modal.getInstance(document.getElementById('addStudentModal'));
          modal.hide();
          document.getElementById('toastBody').innerText = 'Added student ' + sid;
          new bootstrap.Toast(document.getElementById('liveToast')).show();
        }
      });
      // Accept/Deny appeal
      document.getElementById('confirmAcceptBtn').addEventListener('click', () => {
        const row = document.querySelector('#appealsTable tr');
        if (row) row.remove();
        const modal = bootstrap.Modal.getInstance(document.getElementById('acceptModal'));
        modal.hide();
        document.getElementById('toastBody').innerText = 'Appeal accepted and grade updated.';
        new bootstrap.Toast(document.getElementById('liveToast')).show();
      });
      document.getElementById('confirmDenyBtn').addEventListener('click', () => {
        const row = document.querySelector('#appealsTable tr');
        if (row) row.remove();
        const modal = bootstrap.Modal.getInstance(document.getElementById('denyModal'));
        modal.hide();
        document.getElementById('toastBody').innerText = 'Appeal denied.';
        new bootstrap.Toast(document.getElementById('liveToast')).show();
      });
    </script>

    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
      import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
      import { getFirestore, collection, query, where, getDocs, orderBy, addDoc, deleteDoc, doc, limit } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';

      const firebaseConfig = {
        apiKey: "AIzaSyDNsI_tV0KE-hdnN_XGpQaus3vd5snJVxs",
        authDomain: "aigrading-2c9a9.firebaseapp.com",
        projectId: "aigrading-2c9a9",
        storageBucket: "aigrading-2c9a9.appspot.com",
        messagingSenderId: "121677391627",
        appId: "1:121677391627:web:f0fb8ab7a800299e94240e",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const params = new URLSearchParams(window.location.search);
      const classIdParam = params.get('classId') || 'class123';
      let currentUser = null;
      let courseId = `course_general_${classIdParam}`;

      // Load enrolled students for this course
      async function loadEnrolledStudents() {
        try {
          const q = query(
            collection(db, 'enrollment'),
            where('courseId', '==', courseId),
            where('roleInCourse', '==', 'student')
          );
          const snap = await getDocs(q);
          const enrolledStudents = [];
          
          for (const enrollmentDoc of snap.docs) {
            const enrollment = enrollmentDoc.data();
            const userQuery = query(collection(db, 'user'), where('__name__', '==', enrollment.userId), limit(1));
            const userSnap = await getDocs(userQuery);
            if (!userSnap.empty) {
              const user = userSnap.docs[0].data();
              enrolledStudents.push({
                id: enrollment.userId,
                name: `${user.firstName || ''} ${user.lastName || ''}`.trim() || enrollment.userId,
                enrollmentId: enrollmentDoc.id
              });
            }
          }

          // Render roster table
          const rosterTable = document.getElementById('rosterTable');
          rosterTable.innerHTML = enrolledStudents.map(student => `
            <tr>
              <td>${student.id}</td>
              <td>${student.name}</td>
              <td>
                <button class="btn btn-sm btn-outline-danger remove-student-btn" data-enrollment-id="${student.enrollmentId}" data-student-id="${student.id}">
                  <i class="bi bi-person-x"></i>
                </button>
              </td>
            </tr>
          `).join('');

          // Populate add student dropdown with non-enrolled students
          await populateStudentDropdown(enrolledStudents.map(s => s.id));
        } catch (e) {
          console.error('Failed to load enrolled students:', e);
        }
      }

      // Populate student dropdown with students not already enrolled
      async function populateStudentDropdown(excludeIds = []) {
        try {
          const q = query(collection(db, 'user'), where('role', '==', 'student'));
          const snap = await getDocs(q);
          const availableStudents = [];
          
          snap.forEach(doc => {
            const user = doc.data();
            if (!excludeIds.includes(doc.id)) {
              availableStudents.push({
                id: doc.id,
                name: `${user.firstName || ''} ${user.lastName || ''}`.trim() || doc.id
              });
            }
          });

          const select = document.getElementById('addStudentSelect');
          select.innerHTML = '<option value="">Select a student...</option>' +
            availableStudents.map(student => 
              `<option value="${student.id}">${student.id} – ${student.name}</option>`
            ).join('');
        } catch (e) {
          console.error('Failed to load available students:', e);
        }
      }

      // Add student to course
      async function addStudentToCourse(studentId) {
        try {
          const enrollmentId = `${courseId}_${studentId}`;
          await addDoc(collection(db, 'enrollment'), {
            courseId: courseId,
            userId: studentId,
            roleInCourse: 'student',
            createdAt: new Date()
          });
          
          // Reload the roster
          await loadEnrolledStudents();
          showToast('Student added successfully');
        } catch (e) {
          console.error('Failed to add student:', e);
          showToast('Failed to add student', 'error');
        }
      }

      // Remove student from course
      async function removeStudentFromCourse(enrollmentId) {
        try {
          await deleteDoc(doc(db, 'enrollment', enrollmentId));
          
          // Reload the roster
          await loadEnrolledStudents();
          showToast('Student removed successfully');
        } catch (e) {
          console.error('Failed to remove student:', e);
          showToast('Failed to remove student', 'error');
        }
      }

      // Show toast notification
      function showToast(message, type = 'success') {
        const toastBody = document.getElementById('toastBody');
        if (toastBody) {
          toastBody.textContent = message;
          const toast = new bootstrap.Toast(document.getElementById('liveToast'));
          toast.show();
        }
      }

      async function loadAssignments() {
        try {
          const q = query(
            collection(db, 'assignment'),
            where('courseId', '==', courseId)
          );
          const snap = await getDocs(q);
          const items = [];
          snap.forEach(docSnap => {
            const a = docSnap.data();
            const dueText = a.dueAt && a.dueAt.toDate ? a.dueAt.toDate().toLocaleString() : '—';
            items.push({ id: docSnap.id, title: a.title || docSnap.id, dueText });
          });

          if (items.length > 0) {
            const assignmentList = document.getElementById('assignmentList');
            assignmentList.innerHTML = items.map(asmt => `
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div><strong>${asmt.id}</strong> – ${asmt.title} <small class="text-muted">(Due ${asmt.dueText})</small></div>
                <a href="grade-queue.html?classId=${classIdParam}&assignmentId=${asmt.id}" class="btn btn-sm btn-outline-primary">Grade</a>
              </li>
            `).join('');
            const newLink = document.getElementById('newAssignLink');
            if (newLink) newLink.href = `assignment-new.html?classId=${classIdParam}`;
          }
        } catch (e) {
          console.error('Failed to load assignments:', e);
        }
      }

      // Event listeners for roster management
      document.addEventListener('click', async (e) => {
        if (e.target.closest('.remove-student-btn')) {
          const btn = e.target.closest('.remove-student-btn');
          const enrollmentId = btn.getAttribute('data-enrollment-id');
          if (confirm('Are you sure you want to remove this student?')) {
            await removeStudentFromCourse(enrollmentId);
          }
        }
      });

      // Add student confirm button
      document.getElementById('confirmAddBtn').addEventListener('click', async () => {
        const select = document.getElementById('addStudentSelect');
        const studentId = select.value;
        if (studentId) {
          await addStudentToCourse(studentId);
          const modal = bootstrap.Modal.getInstance(document.getElementById('addStudentModal'));
          modal.hide();
        }
      });

      // Load submissions for this course
      async function loadSubmissions() {
        try {
          const q = query(
            collection(db, 'submission'),
            where('courseId', '==', courseId)
          );
          const snap = await getDocs(q);
          const submissions = [];
          
          for (const submissionDoc of snap.docs) {
            const submission = submissionDoc.data();
            
            // Get student info
            const studentQuery = query(collection(db, 'user'), where('__name__', '==', submission.studentId), limit(1));
            const studentSnap = await getDocs(studentQuery);
            const studentName = studentSnap.empty ? submission.studentId : 
              `${studentSnap.docs[0].data().firstName || ''} ${studentSnap.docs[0].data().lastName || ''}`.trim() || submission.studentId;
            
            submissions.push({
              id: submissionDoc.id,
              studentId: submission.studentId,
              studentName: studentName,
              assignmentId: submission.assignmentId,
              fileName: submission.fileName || 'No file',
              fileSize: submission.fileSize || 0,
              codeLanguage: submission.codeLanguage || 'text',
              status: submission.status || 'pending',
              score: submission.score || null,
              submittedAt: submission.submittedAt,
              fileContent: submission.fileContent
            });
          }

          // Populate assignment filter
          const assignmentIds = [...new Set(submissions.map(s => s.assignmentId))];
          const assignmentFilter = document.getElementById('submissionAssignmentFilter');
          assignmentFilter.innerHTML = '<option value="">All Assignments</option>' +
            assignmentIds.map(id => `<option value="${id}">${id}</option>`).join('');

          // Render submissions table
          renderSubmissionsTable(submissions);
          
          // Add filter event listeners
          document.getElementById('submissionAssignmentFilter').addEventListener('change', () => renderSubmissionsTable(submissions));
          document.getElementById('submissionStatusFilter').addEventListener('change', () => renderSubmissionsTable(submissions));
          
        } catch (e) {
          console.error('Failed to load submissions:', e);
        }
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
      }

      function getFileIcon(fileName) {
        if (fileName === 'No file') return '📄';
        const ext = fileName.split('.').pop().toLowerCase();
        const iconMap = {
          'java': '☕',
          'py': '🐍',
          'html': '🌐',
          'css': '🎨',
          'js': '📜',
          'txt': '📄'
        };
        return iconMap[ext] || '📄';
      }

      function downloadFile(submission) {
        if (!submission.fileContent || submission.fileName === 'No file') return;
        
        const blob = new Blob([submission.fileContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = submission.fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function renderSubmissionsTable(allSubmissions) {
        const assignmentFilter = document.getElementById('submissionAssignmentFilter').value;
        const statusFilter = document.getElementById('submissionStatusFilter').value;
        
        let filtered = allSubmissions;
        if (assignmentFilter) {
          filtered = filtered.filter(s => s.assignmentId === assignmentFilter);
        }
        if (statusFilter) {
          filtered = filtered.filter(s => s.status === statusFilter);
        }

        const tableBody = document.getElementById('submissionsTable');
        tableBody.innerHTML = filtered.map(submission => {
          const fileSize = submission.fileSize ? formatFileSize(submission.fileSize) : '';
          const fileIcon = getFileIcon(submission.fileName);
          const language = submission.codeLanguage ? ` (${submission.codeLanguage})` : '';
          const fileInfo = `${fileIcon} ${submission.fileName}${language}${fileSize ? ` - ${fileSize}` : ''}`;
          
          const scoreText = submission.score !== null ? `${submission.score}/100` : '—';
          const submittedText = submission.submittedAt && submission.submittedAt.toDate ? 
            submission.submittedAt.toDate().toLocaleString() : '—';
          
          const statusBadge = submission.status === 'graded' ? 'success' : 
                             submission.status === 'pending' ? 'warning' : 'secondary';
          
          return `
            <tr>
              <td>${submission.studentName}</td>
              <td>${submission.assignmentId}</td>
              <td><small>${fileInfo}</small></td>
              <td><span class="badge bg-${statusBadge}">${submission.status}</span></td>
              <td>${scoreText}</td>
              <td><small>${submittedText}</small></td>
              <td>
                ${submission.fileName !== 'No file' ? 
                  `<button onclick="downloadFile(${JSON.stringify(submission).replace(/"/g, '&quot;')})" class="btn btn-sm btn-outline-primary me-1">Download</button>` : 
                  '<span class="text-muted">No file</span>'
                }
                <button class="btn btn-sm btn-outline-success" onclick="gradeSubmission('${submission.id}')">Grade</button>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Make functions globally accessible
      window.downloadFile = downloadFile;
      window.gradeSubmission = (submissionId) => {
        // Placeholder for grading functionality
        showToast('Grading functionality coming soon!');
      };

      onAuthStateChanged(auth, (user) => {
        if (!user) {
          // Optional: enforce auth here
        }
        currentUser = user;
        loadAssignments();
        loadEnrolledStudents();
        loadSubmissions();
      });
    </script>
  </body>
</html>
